if form.validate_on_submit():    
       firstname=request.form['firstname']
       lastname=request.form ['lastname']
       password=request.form['password']
       email=request.form['email']
    
       try:
    
        with connection.cursor() as cursor:
            sql= "INSERT INTO `users` (`firstname`, `lastname`, `email`, `password`) VALUES (%s, %s, %s, %s)"
            cursor.execute(sql,(firstname,lastname,email,password))
            connection.commit()
            flash('data added')
            session['user'] = request.form['email']
            return redirect(url_for('first_page'))
       except:
          # Close the connection, regardless of whether or not the above was successful
        flash("An exception occurred")
          
 form = LoginForm()
  
 if request.method == 'POST' and form.validate_on_submit():
           email  = request.form['email']
           try:
                with connection.cursor() as cursor:
                    sql=("SELECT COUNT(1) FROM users WHERE email = {};".format(email))
                    cursor.execute(sql)
                    result = cursor.fetchone()
                    if not result[0]:
                        raise ServerError('Invalid username')
                        return redirect('/')
                    password  = generate_password_hash(request.form['password'])
                    sql=("SELECT password FROM users WHERE email = {};".format(email))
                    cursor.execute(sql)
                    
                    for row in result():
                        if password == row[0]:
                            session['user'] = request.form['email']
                            raise ServerError('Invalid password')
                            return redirect(url_for('first_page'))
    
           return render_template('index.html', form=form)